<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å®Ÿç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f1f5f9;
            color: #1e293b;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #1e293b;
        }

        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .month-selector {
            padding: 10px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            cursor: pointer;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .menu-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-card:hover {
            border-color: #3b82f6;
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15);
        }

        .menu-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .menu-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .menu-desc {
            font-size: 14px;
            color: #64748b;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .card .subtitle {
            color: #64748b;
            margin-bottom: 24px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #1e293b;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .csv-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: #f8fafc;
            margin: 24px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .csv-zone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .csv-preview {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 500px;
            overflow: auto;
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .csv-table th {
            background: #f1f5f9;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
        }

        .csv-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-section h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #475569;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
        }

        .unit-display {
            background: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #64748b;
            margin-top: 8px;
        }

        .customer-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .customer-name {
            font-size: 16px;
            font-weight: 600;
        }

        .profit-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .profit-card.danger {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .profit-card.warning {
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }

        .profit-card.success {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }

        .profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .profit-rate {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 700;
        }

        .profit-rate.danger {
            background: #ef4444;
            color: white;
        }

        .profit-rate.warning {
            background: #f59e0b;
            color: white;
        }

        .profit-rate.success {
            background: #10b981;
            color: white;
        }

        .profit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .profit-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .profit-label {
            font-size: 12px;
            color: #64748b;
        }

        .profit-value {
            font-size: 16px;
            font-weight: 600;
        }

        .warning-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .warning-box h4 {
            color: #dc2626;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .category-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }

        .category-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .category-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .category-row:last-child {
            border-top: 2px solid #e2e8f0;
            margin-top: 8px;
            padding-top: 12px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-muted {
            color: #64748b;
        }

        .text-danger {
            color: #ef4444;
        }

        .text-success {
            color: #10b981;
        }

        .format-box {
            margin-top: 24px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .format-box h4 {
            margin-bottom: 12px;
        }

        .format-box pre {
            background: white;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background: #cbd5e1;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“Š å®Ÿç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <div class="text-muted">å£²ä¸Šãƒ»å‡¦åˆ†æ–™ã®ç®¡ç†ã¨ç²—åˆ©åˆ†æ</div>
            </div>
            <div class="header-right">
                <select id="yearMonthSelector" class="month-selector" onchange="selectYearMonth(this.value)">
                    <!-- JavaScript ã§ç”Ÿæˆ -->
                </select>
            </div>
        </div>

        <div id="content">
            <!-- JavaScript ã§ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyX-HnH7rTzOlAQaYzdA_ULqQXFrzW4AznRvkjXBzfwOES74atBGCwwO3Lhpr8AAAePCw/exec'; // â† ã“ã“ã‚’å¤‰æ›´

        // ========================================
        // State
        // ========================================
        const state = {
            currentView: 'menu',
            selectedYearMonth: null,
            sales: [],
            disposalCosts: [],
            profitAnalysis: null,
            customers: [],
            wasteTypes: [],      // å»ƒæ£„ç‰©ç¨®é¡ãƒã‚¹ã‚¿
            facilities: [],      // å‡¦åˆ†å ´ãƒã‚¹ã‚¿
            newDisposal: {       // æ–°è¦å…¥åŠ›ä¸­ã®ãƒ‡ãƒ¼ã‚¿
                facility: '',
                customerCode: '',
                wasteType: '',
                quantity: '',
                unitPrice: '',
                notes: ''
            }
        };

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        async function init() {
            console.log('ğŸš€ å®Ÿç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0');
            
            // å¹´æœˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
            generateYearMonthSelector();
            
            // ä»Šæœˆã‚’é¸æŠ
            const today = new Date();
            state.selectedYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('yearMonthSelector').value = state.selectedYearMonth;
            
            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadCustomers();
            await loadWasteTypes();
            await loadFacilities();
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
            render();
        }

        // ========================================
        // GAS API
        // ========================================
        async function callGAS(params) {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(params)
                    // headersã‚’å‰Šé™¤ã—ã¦ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆã‚’å›é¿
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error('API ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        async function loadCustomers() {
            const result = await callGAS({ action: 'getCustomers' });
            if (result.success) {
                state.customers = result.data.customers || [];
            }
        }

        async function loadWasteTypes() {
            const result = await callGAS({ action: 'getWasteTypes' });
            if (result.success) {
                state.wasteTypes = result.data || [];
            }
        }

        async function loadFacilities() {
            const result = await callGAS({ action: 'getFacilities' });
            if (result.success) {
                state.facilities = result.data || [];
            }
        }

        async function loadSalesData(yearMonth) {
            showLoading('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
            try {
                const result = await callGAS({ 
                    action: 'getSalesData',
                    yearMonth: yearMonth 
                });
                if (result.success) {
                    state.sales = result.data || [];
                }
            } finally {
                hideLoading();
            }
        }

        async function importCSV(csvText) {
            showLoading('CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™...');
            try {
                const result = await callGAS({
                    action: 'importSalesCSV',
                    yearMonth: state.selectedYearMonth,
                    csvData: csvText
                });
                
                if (result.success) {
                    if (result.errors && result.errors.length > 0) {
                        alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næˆåŠŸ: ${result.imported}ä»¶\nã‚¨ãƒ©ãƒ¼: ${result.errors.length}ä»¶\n\n${result.errors.join('\n')}`);
                    } else {
                        alert(`${result.imported}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                    }
                    await loadSalesData(state.selectedYearMonth);
                    state.currentView = 'menu';
                    render();
                }
            } catch (error) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function saveDisposalCost(data) {
            showLoading('å‡¦åˆ†æ–™ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...');
            try {
                const result = await callGAS({
                    action: 'saveDisposalCosts',
                    data: data
                });
                if (result.success) {
                    await loadDisposalCosts(state.selectedYearMonth);
                    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                    state.newDisposal = {
                        facility: '',
                        customerCode: '',
                        wasteType: '',
                        quantity: '',
                        unitPrice: '',
                        notes: ''
                    };
                    render();
                    alert('å‡¦åˆ†æ–™ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                }
            } finally {
                hideLoading();
            }
        }

        async function saveGeneralDisposalCost(data) {
            showLoading('ä¸€èˆ¬å»ƒæ£„ç‰©å‡¦åˆ†æ–™ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...');
            try {
                const result = await callGAS({
                    action: 'saveGeneralDisposalCost',
                    data: data
                });
                if (result.success) {
                    await loadDisposalCosts(state.selectedYearMonth);
                    render();
                    alert('ä¸€èˆ¬å»ƒæ£„ç‰©å‡¦åˆ†æ–™ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                }
            } finally {
                hideLoading();
            }
        }

        async function deleteDisposalCost(id) {
            if (!confirm('ã“ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            showLoading('å‰Šé™¤ã—ã¦ã„ã¾ã™...');
            try {
                const result = await callGAS({
                    action: 'deleteDisposalCost',
                    id: id
                });
                if (result.success) {
                    await loadDisposalCosts(state.selectedYearMonth);
                    render();
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                }
            } finally {
                hideLoading();
            }
        }

        async function loadDisposalCosts(yearMonth) {
            const result = await callGAS({
                action: 'getDisposalCosts',
                yearMonth: yearMonth
            });
            if (result.success) {
                state.disposalCosts = result.data || [];
            }
        }

        async function calculateProfit() {
            showLoading('ç²—åˆ©ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™...');
            try {
                const result = await callGAS({
                    action: 'calculateProfitAnalysis',
                    yearMonth: state.selectedYearMonth
                });
                if (result.success) {
                    state.profitAnalysis = result.data;
                    render();
                }
            } finally {
                hideLoading();
            }
        }

        // ========================================
        // UI
        // ========================================
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function generateYearMonthSelector() {
            const selector = document.getElementById('yearMonthSelector');
            const today = new Date();
            
            for (let i = 0; i < 24; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const label = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                selector.appendChild(option);
            }
        }

        function selectYearMonth(yearMonth) {
            state.selectedYearMonth = yearMonth;
            loadSalesData(yearMonth);
            loadDisposalCosts(yearMonth);
            render();
        }

        function switchView(view) {
            state.currentView = view;
            if (view === 'import') {
                // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆç”»é¢ã‚’é–‹ãå‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                setTimeout(() => {
                    const preview = document.getElementById('csvPreviewArea');
                    if (preview) preview.innerHTML = '';
                }, 0);
            } else if (view === 'disposal') {
                loadDisposalCosts(state.selectedYearMonth);
            } else if (view === 'analysis') {
                state.profitAnalysis = null;
            }
            render();
        }

        function formatCurrency(num) {
            return 'Â¥' + (num || 0).toLocaleString('ja-JP');
        }

        function formatPercent(num) {
            return (num || 0).toFixed(1) + '%';
        }

        // ========================================
        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // ========================================
        function render() {
            const content = document.getElementById('content');
            
            switch (state.currentView) {
                case 'menu':
                    content.innerHTML = renderMenu();
                    break;
                case 'import':
                    content.innerHTML = renderImport();
                    break;
                case 'disposal':
                    content.innerHTML = renderDisposal();
                    break;
                case 'analysis':
                    content.innerHTML = renderAnalysis();
                    break;
            }
        }

        function renderMenu() {
            return `
                <div class="menu-grid">
                    <div class="menu-card" onclick="switchView('import')">
                        <div class="menu-icon">ğŸ“¥</div>
                        <div class="menu-title">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                        <div class="menu-desc">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€</div>
                    </div>
                    
                    <div class="menu-card" onclick="switchView('disposal')">
                        <div class="menu-icon">ğŸ’°</div>
                        <div class="menu-title">å‡¦åˆ†æ–™å…¥åŠ›</div>
                        <div class="menu-desc">å‡¦åˆ†æ–™ã‚’ç™»éŒ²ã™ã‚‹</div>
                    </div>
                    
                    <div class="menu-card" onclick="switchView('analysis')">
                        <div class="menu-icon">ğŸ“ˆ</div>
                        <div class="menu-title">ç²—åˆ©ç‡åˆ†æ</div>
                        <div class="menu-desc">é¡§å®¢åˆ¥ã®ç²—åˆ©ã‚’ç¢ºèª</div>
                    </div>
                </div>
            `;
        }

        function renderImport() {
            return `
                <button class="back-button" onclick="switchView('menu')">
                    â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                </button>
                
                <div class="card">
                    <h2>ğŸ“¥ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                    <div class="subtitle">Excelã§ä½œæˆã—ãŸå£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§å–ã‚Šè¾¼ã¿ã¾ã™</div>
                    
                    <div class="csv-zone" onclick="document.getElementById('csvFile').click()">
                        <div style="font-size: 56px; margin-bottom: 16px;">ğŸ“„</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </div>
                        <div class="text-muted">
                            å¯¾è±¡å¹´æœˆ: ${state.selectedYearMonth}
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSV(event)">
                    </div>
                    
                    <div id="csvPreviewArea"></div>
                    
                    <div class="format-box">
                        <h4>ğŸ“‹ CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h4>
                        <pre>ã‚³ãƒ¼ãƒ‰,é¡§å®¢å,æœˆæ¥µ,ä¸€èˆ¬ã¥,ç²—å¤§,ãƒ€ãƒ³ãƒœãƒ¼ãƒ«,ç”£å»ƒ,å¾ªç’°ç¨,å»ºå»ƒ,å»ƒå®¶é›»,ãƒ—ãƒªãƒšã‚¤ãƒ‰+é‡‘å±
1100,ä½è—¤å•†åº—,10000,0,0,0,0,0,0,0,0
1101,éˆ´æœ¨å•†äº‹,0,0,0,5000,0,0,0,0,0</pre>
                        <p class="text-muted" style="margin-top: 12px; font-size: 13px;">
                            â€» é¡§å®¢åã¯çœç•¥å¯èƒ½ï¼ˆé¡§å®¢ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰<br>
                            â€» æ—¢å­˜ã®åŒæœˆãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™
                        </p>
                    </div>
                </div>
            `;
        }

        function handleCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                displayCSVPreview(csvText);
            };
            reader.readAsText(file, 'Shift_JIS');
        }

        function displayCSVPreview(csvText) {
            window.currentCSV = csvText; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
            
            const lines = csvText.split('\n').filter(line => line.trim());
            const preview = document.getElementById('csvPreviewArea');
            
            if (lines.length === 0) {
                preview.innerHTML = '<div class="text-danger">CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™</div>';
                return;
            }
            
            let html = `
                <div class="csv-preview">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div><strong>${lines.length}ä»¶</strong>ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º</div>
                        <button class="btn btn-primary" onclick="executeImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                    </div>
                    <table class="csv-table">
                        <thead>
                            <tr>
                                <th>ã‚³ãƒ¼ãƒ‰</th><th>é¡§å®¢å</th><th>æœˆæ¥µ</th><th>ä¸€èˆ¬ã¥</th><th>ç²—å¤§</th>
                                <th>ãƒ€ãƒ³ãƒœãƒ¼ãƒ«</th><th>ç”£å»ƒ</th><th>å¾ªç’°ç¨</th><th>å»ºå»ƒ</th><th>å»ƒå®¶é›»</th><th>ãƒ—ãƒªãƒšã‚¤ãƒ‰</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let i = 0; i < Math.min(lines.length, 20); i++) {
                const cols = lines[i].split(',');
                html += '<tr>';
                for (let j = 0; j < 11; j++) {
                    html += `<td>${cols[j] || ''}</td>`;
                }
                html += '</tr>';
            }
            
            if (lines.length > 20) {
                html += `<tr><td colspan="11" style="text-align: center;" class="text-muted">...ä»– ${lines.length - 20}ä»¶</td></tr>`;
            }
            
            html += '</tbody></table></div>';
            preview.innerHTML = html;
        }

        async function executeImport() {
            if (!window.currentCSV) return;
            if (!confirm(`${state.selectedYearMonth}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            await importCSV(window.currentCSV);
        }

        function renderDisposal() {
            // ä¸€èˆ¬å»ƒæ£„ç‰©ã®å‡¦åˆ†æ–™
            const generalCost = state.disposalCosts.find(c => c.wasteType === 'ä¸€èˆ¬å»ƒæ£„ç‰©') || {};
            
            // ç”£å»ƒãƒ»å»ºå»ƒã®æ˜ç´°ï¼ˆä¸€èˆ¬å»ƒæ£„ç‰©ä»¥å¤–ï¼‰
            const otherCosts = state.disposalCosts.filter(c => c.wasteType !== 'ä¸€èˆ¬å»ƒæ£„ç‰©');
            
            return `
                <button class="back-button" onclick="switchView('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                
                <div class="card">
                    <h2>ğŸ’° å‡¦åˆ†æ–™å…¥åŠ›</h2>
                    <div class="subtitle">å‡¦åˆ†æ–™ã‚’ç™»éŒ²ã—ã¦ç²—åˆ©ã‚’è¨ˆç®—ã—ã¾ã™</div>
                    
                    <!-- ä¸€èˆ¬å»ƒæ£„ç‰©ï¼ˆæœˆæ¬¡ä¸€æ‹¬ï¼‰ -->
                    <div class="form-section">
                        <h3>ğŸ—‘ï¸ ä¸€èˆ¬å»ƒæ£„ç‰©ï¼ˆæœˆæ¬¡ä¸€æ‹¬ï¼‰</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ç·æ¬å…¥é‡ï¼ˆkgï¼‰</label>
                                <input type="number" id="general_quantity" value="${generalCost.quantity || ''}" placeholder="8000">
                            </div>
                            <div class="form-group">
                                <label>ç·å‡¦åˆ†æ–™ï¼ˆå††ï¼‰</label>
                                <input type="number" id="general_cost" value="${generalCost.totalCost || ''}" placeholder="200000">
                            </div>
                            <div class="form-group">
                                <label>å‡¦åˆ†å ´</label>
                                <select id="general_facility">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    ${state.facilities.map(f => `
                                        <option value="${f.name}" ${f.name === generalCost.facility ? 'selected' : ''}>
                                            ${f.name}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å‚™è€ƒ</label>
                                <input type="text" id="general_notes" value="${generalCost.notes || ''}" placeholder="å‚™è€ƒ">
                            </div>
                        </div>
                        ${generalCost.quantity && generalCost.totalCost ? `
                            <div class="unit-display">ğŸ’¡ å˜ä¾¡: Â¥${(generalCost.totalCost / generalCost.quantity).toFixed(2)}/kg</div>
                        ` : ''}
                        <button class="btn btn-primary" onclick="saveGeneral()" style="margin-top: 16px;">ä¿å­˜</button>
                    </div>
                    
                    <!-- ç”£å»ƒãƒ»å»ºå»ƒï¼ˆå‡¦åˆ†å ´åˆ¥æ˜ç´°ï¼‰ -->
                    <div class="form-section">
                        <h3>ğŸ­ ç”£å»ƒãƒ»å»ºå»ƒï¼ˆå‡¦åˆ†å ´åˆ¥æ˜ç´°ï¼‰</h3>
                        
                        <!-- æ–°è¦å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                        <div style="background: white; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 16px; color: #3b82f6;">ğŸ“ æ–°è¦æ˜ç´°ã‚’è¿½åŠ </h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>å‡¦åˆ†å ´ <span style="color: #ef4444;">*</span></label>
                                    <select id="new_facility" onchange="updateNewDisposal('facility', this.value)">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        ${state.facilities.map(f => `
                                            <option value="${f.name}" ${state.newDisposal.facility === f.name ? 'selected' : ''}>
                                                ${f.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>é¡§å®¢ã‚³ãƒ¼ãƒ‰ <span style="color: #ef4444;">*</span></label>
                                    <input type="text" 
                                           id="new_customerCode" 
                                           value="${state.newDisposal.customerCode}" 
                                           onchange="updateNewDisposal('customerCode', this.value)"
                                           onblur="loadCustomerName(this.value)"
                                           placeholder="1100"
                                           list="customerCodes">
                                    <datalist id="customerCodes">
                                        ${state.customers.map(c => `
                                            <option value="${c.code}">${c.name}</option>
                                        `).join('')}
                                    </datalist>
                                </div>
                                <div class="form-group">
                                    <label>å»ƒæ£„ç‰©ç¨®é¡ <span style="color: #ef4444;">*</span></label>
                                    <select id="new_wasteType" onchange="updateNewDisposal('wasteType', this.value); loadDefaultUnitPrice(this.value, document.getElementById('new_customerCode').value)">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        ${state.wasteTypes.filter(w => w.category !== 'general').map(w => `
                                            <option value="${w.name}" ${state.newDisposal.wasteType === w.name ? 'selected' : ''}>
                                                ${w.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>æ•°é‡ï¼ˆkgï¼‰ <span style="color: #ef4444;">*</span></label>
                                    <input type="number" 
                                           id="new_quantity" 
                                           value="${state.newDisposal.quantity}" 
                                           onchange="updateNewDisposal('quantity', this.value); calculateTotal()"
                                           placeholder="500">
                                </div>
                                <div class="form-group">
                                    <label>å˜ä¾¡ï¼ˆå††/kgï¼‰ <span style="color: #ef4444;">*</span></label>
                                    <input type="number" 
                                           id="new_unitPrice" 
                                           value="${state.newDisposal.unitPrice}" 
                                           onchange="updateNewDisposal('unitPrice', this.value); calculateTotal()"
                                           placeholder="30">
                                </div>
                                <div class="form-group">
                                    <label>å‚™è€ƒ</label>
                                    <input type="text" 
                                           id="new_notes" 
                                           value="${state.newDisposal.notes}" 
                                           onchange="updateNewDisposal('notes', this.value)"
                                           placeholder="å‚™è€ƒ">
                                </div>
                            </div>
                            <div id="customerNameDisplay" style="margin: 12px 0; padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 14px; display: none;">
                                <strong>é¡§å®¢å:</strong> <span id="customerNameText"></span>
                            </div>
                            <div id="totalCostDisplay" style="margin: 12px 0; padding: 16px; background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; font-size: 18px; font-weight: 700; text-align: center; display: none;">
                                åˆè¨ˆé‡‘é¡: <span id="totalCostText" style="color: #3b82f6;">Â¥0</span>
                            </div>
                            <button class="btn btn-primary" onclick="addNewDisposal()" style="width: 100%; margin-top: 16px;">
                                âœ… ç™»éŒ²
                            </button>
                        </div>
                        
                        <!-- ç™»éŒ²æ¸ˆã¿æ˜ç´°ä¸€è¦§ -->
                        <h4 style="margin: 24px 0 12px 0;">ğŸ“‹ ç™»éŒ²æ¸ˆã¿æ˜ç´°ï¼ˆ${otherCosts.length}ä»¶ï¼‰</h4>
                        ${otherCosts.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #64748b; background: #f8fafc; border-radius: 8px;">
                                ã¾ã æ˜ç´°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                            </div>
                        ` : `
                            <div style="display: grid; gap: 12px;">
                                ${otherCosts.map(cost => renderDisposalItem(cost)).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderDisposalItem(cost) {
            const totalCost = cost.quantity * cost.unitPrice;
            return `
                <div class="customer-item" style="background: white;">
                    <div class="customer-header">
                        <div>
                            <div class="customer-name">${cost.customerName || cost.customerCode}</div>
                            <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                                ${cost.facility} | ${cost.wasteType}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteDisposalCost('${cost.id}')">å‰Šé™¤</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                        <div>
                            <div class="profit-label">æ•°é‡</div>
                            <div class="profit-value">${cost.quantity.toLocaleString()} kg</div>
                        </div>
                        <div>
                            <div class="profit-label">å˜ä¾¡</div>
                            <div class="profit-value">Â¥${cost.unitPrice.toLocaleString()}/kg</div>
                        </div>
                        <div>
                            <div class="profit-label">åˆè¨ˆé‡‘é¡</div>
                            <div class="profit-value" style="color: #3b82f6;">Â¥${totalCost.toLocaleString()}</div>
                        </div>
                    </div>
                    ${cost.notes ? `
                        <div style="margin-top: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 13px; color: #64748b;">
                            ğŸ“ ${cost.notes}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateNewDisposal(field, value) {
            state.newDisposal[field] = value;
        }

        function loadCustomerName(code) {
            const customer = state.customers.find(c => c.code === code);
            if (customer) {
                document.getElementById('customerNameDisplay').style.display = 'block';
                document.getElementById('customerNameText').textContent = customer.name;
            } else {
                document.getElementById('customerNameDisplay').style.display = 'none';
            }
        }

        function loadDefaultUnitPrice(wasteTypeName, customerCode) {
            // éå»ã®å®Ÿç¸¾ã‹ã‚‰å˜ä¾¡ã‚’å–å¾—
            const pastCost = state.disposalCosts.find(c => 
                c.customerCode === customerCode && c.wasteType === wasteTypeName
            );
            
            if (pastCost && pastCost.unitPrice) {
                state.newDisposal.unitPrice = pastCost.unitPrice;
                document.getElementById('new_unitPrice').value = pastCost.unitPrice;
            } else {
                // ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå˜ä¾¡ã‚’ä½¿ç”¨
                const wasteType = state.wasteTypes.find(w => w.name === wasteTypeName);
                if (wasteType && wasteType.defaultUnitPrice) {
                    state.newDisposal.unitPrice = wasteType.defaultUnitPrice;
                    document.getElementById('new_unitPrice').value = wasteType.defaultUnitPrice;
                }
            }
            calculateTotal();
        }

        function calculateTotal() {
            const quantity = parseFloat(state.newDisposal.quantity) || 0;
            const unitPrice = parseFloat(state.newDisposal.unitPrice) || 0;
            const total = quantity * unitPrice;
            
            if (total > 0) {
                document.getElementById('totalCostDisplay').style.display = 'block';
                document.getElementById('totalCostText').textContent = 'Â¥' + total.toLocaleString();
            } else {
                document.getElementById('totalCostDisplay').style.display = 'none';
            }
        }

        async function addNewDisposal() {
            const { facility, customerCode, wasteType, quantity, unitPrice, notes } = state.newDisposal;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!facility) {
                alert('å‡¦åˆ†å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!customerCode) {
                alert('é¡§å®¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!wasteType) {
                alert('å»ƒæ£„ç‰©ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!quantity || quantity <= 0) {
                alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!unitPrice || unitPrice <= 0) {
                alert('å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // é¡§å®¢åã‚’å–å¾—
            const customer = state.customers.find(c => c.code === customerCode);
            const customerName = customer ? customer.name : '';
            
            if (!customerName) {
                alert('é¡§å®¢ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
            const totalCost = parseFloat(quantity) * parseFloat(unitPrice);
            
            // ä¿å­˜
            await saveDisposalCost({
                yearMonth: state.selectedYearMonth,
                facility: facility,
                customerCode: customerCode,
                customerName: customerName,
                wasteType: wasteType,
                quantity: parseFloat(quantity),
                unitPrice: parseFloat(unitPrice),
                totalCost: totalCost,
                notes: notes
            });
        }

        async function saveGeneral() {
            const quantity = parseFloat(document.getElementById('general_quantity').value);
            const cost = parseFloat(document.getElementById('general_cost').value);
            const facility = document.getElementById('general_facility').value;
            const notes = document.getElementById('general_notes').value;
            
            if (!quantity || !cost) {
                alert('ç·æ¬å…¥é‡ã¨ç·å‡¦åˆ†æ–™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!facility) {
                alert('å‡¦åˆ†å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            await saveGeneralDisposalCost({
                yearMonth: state.selectedYearMonth,
                facility: facility,
                quantity: quantity,
                totalCost: cost,
                notes: notes
            });
        }

        // ä»–ã®å‡¦åˆ†æ–™é–¢é€£é–¢æ•°ã¯çœç•¥ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

        function renderAnalysis() {
            if (!state.profitAnalysis) {
                return `
                    <button class="back-button" onclick="switchView('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                    
                    <div class="card">
                        <h2>ğŸ“ˆ ç²—åˆ©ç‡åˆ†æ</h2>
                        <div class="subtitle">é¡§å®¢åˆ¥ã®ç²—åˆ©ç‡ã‚’åˆ†æã—ã¾ã™</div>
                        <div style="text-align: center; padding: 80px 20px;">
                            <div style="font-size: 64px; margin-bottom: 24px;">ğŸ“Š</div>
                            <p class="text-muted" style="margin-bottom: 24px;">ç²—åˆ©ã‚’è¨ˆç®—ã—ã¦ãã ã•ã„</p>
                            <button class="btn btn-primary" onclick="calculateProfit()">ç²—åˆ©ã‚’è¨ˆç®—</button>
                        </div>
                    </div>
                `;
            }
            
            const { customerAnalysis, categorySummary } = state.profitAnalysis;
            
            return `
                <button class="back-button" onclick="switchView('menu')">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 24px;">
                        <div>
                            <h2>ğŸ“ˆ ç²—åˆ©ç‡åˆ†æ</h2>
                            <div class="subtitle">${state.selectedYearMonth}</div>
                        </div>
                        <button class="btn btn-primary" onclick="calculateProfit()">å†è¨ˆç®—</button>
                    </div>
                    
                    <h3 style="margin-bottom: 16px;">ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥é›†è¨ˆ</h3>
                    <div class="category-grid">
                        ${renderCategory('ä¸€èˆ¬å»ƒæ£„ç‰©', categorySummary.general)}
                        ${renderCategory('ç”£æ¥­å»ƒæ£„ç‰©', categorySummary.industrial)}
                        ${renderCategory('å»ºè¨­å»ƒæ£„ç‰©', categorySummary.construction)}
                    </div>
                    
                    <h3 style="margin: 32px 0 16px;">ğŸ‘¥ é¡§å®¢åˆ¥åˆ†æï¼ˆç”£å»ƒãƒ»å»ºå»ƒï¼‰</h3>
                    ${customerAnalysis.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            åˆ†æå¯¾è±¡ã®é¡§å®¢ãŒã‚ã‚Šã¾ã›ã‚“
                        </div>
                    ` : customerAnalysis.map(c => renderProfitCard(c)).join('')}
                </div>
            `;
        }

        function renderCategory(title, data) {
            return `
                <div class="category-card">
                    <div class="category-title">${title}</div>
                    <div class="category-row">
                        <span>å£²ä¸Š</span>
                        <span>${formatCurrency(data.sales)}</span>
                    </div>
                    <div class="category-row">
                        <span>å‡¦åˆ†æ–™</span>
                        <span>${formatCurrency(data.cost)}</span>
                    </div>
                    <div class="category-row">
                        <span>ç²—åˆ©</span>
                        <span class="${data.profit < 0 ? 'text-danger' : 'text-success'}">
                            ${formatCurrency(data.profit)}
                        </span>
                    </div>
                    <div class="category-row">
                        <span style="font-weight: 700;">ç²—åˆ©ç‡</span>
                        <span style="font-weight: 700;" class="${data.profitRate < 0 ? 'text-danger' : data.profitRate < 10 ? 'text-muted' : 'text-success'}">
                            ${formatPercent(data.profitRate)}
                        </span>
                    </div>
                </div>
            `;
        }

        function renderProfitCard(customer) {
            return `
                <div class="profit-card ${customer.profitWarningLevel}">
                    <div class="profit-header">
                        <div class="customer-name">${customer.customerName}</div>
                        <div class="profit-rate ${customer.profitWarningLevel}">
                            ${formatPercent(customer.totalProfitRate)}
                        </div>
                    </div>
                    <div class="profit-grid">
                        <div class="profit-item">
                            <div class="profit-label">å£²ä¸Š</div>
                            <div class="profit-value">${formatCurrency(customer.totalSales)}</div>
                        </div>
                        <div class="profit-item">
                            <div class="profit-label">å‡¦åˆ†æ–™</div>
                            <div class="profit-value">${formatCurrency(customer.totalCost)}</div>
                        </div>
                        <div class="profit-item">
                            <div class="profit-label">ç²—åˆ©</div>
                            <div class="profit-value ${customer.totalProfit < 0 ? 'text-danger' : 'text-success'}">
                                ${formatCurrency(customer.totalProfit)}
                            </div>
                        </div>
                    </div>
                    ${customer.profitWarningLevel === 'danger' ? `
                        <div class="warning-box">
                            <h4>âš ï¸ è¦æ³¨æ„</h4>
                            <p style="color: #991b1b; font-size: 13px; line-height: 1.5;">
                                å£²ä¸Šã‚ˆã‚Šå‡¦åˆ†æ–™ãŒé«˜ãã€èµ¤å­—å–å¼•ã¨ãªã£ã¦ã„ã¾ã™ã€‚<br>
                                ä¾¡æ ¼æ”¹å®šã¾ãŸã¯å–å¼•è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ========================================
        // èµ·å‹•
        // ========================================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
