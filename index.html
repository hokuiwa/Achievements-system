<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>å®Ÿç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.4</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:#f1f5f9;color:#0f172a;
    }
    .container{max-width:1400px;margin:0 auto;padding:18px;}
    .topbar{
      position:sticky;top:0;z-index:1000;
      background:rgba(241,245,249,.95);
      backdrop-filter: blur(10px);
      border-bottom:1px solid #e2e8f0;
      box-shadow:0 1px 3px rgba(0,0,0,.05);
    }
    .topbar-inner{
      max-width:1400px;margin:0 auto;padding:14px 18px;
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:flex-start;gap:10px;
      min-width:260px;
    }
    .brand h1{font-size:18px;font-weight:800;letter-spacing:.2px;}
    .brand .sub{font-size:12px;color:#64748b;margin-top:2px;}
    .right-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .month-selector{
      padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;
      font-size:13px;font-weight:700;background:white;cursor:pointer;
    }
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .tab{
      border:1px solid #e2e8f0;background:white;color:#0f172a;
      padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:800;font-size:13px;
      transition:.15s;
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .tab:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.08);}
    .tab.active{
      border-color:#3b82f6;
      box-shadow:0 10px 22px rgba(59,130,246,.18);
    }
    .badge{
      font-size:11px;font-weight:900;
      padding:4px 8px;border-radius:999px;
      background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;
    }

    .card{
      background:white;border-radius:18px;padding:26px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      border:1px solid #eef2f7;
    }
    .card h2{font-size:22px;margin-bottom:8px;}
    .subtitle{color:#64748b;margin-bottom:18px;line-height:1.5;}
    .grid{display:grid;gap:14px;}
    .grid-2{grid-template-columns:1fr 1fr;}
    .grid-3{grid-template-columns:repeat(3,1fr);}
    .grid-4{grid-template-columns:repeat(4,1fr);}
    @media (max-width:900px){
      .grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}
      .brand{min-width:auto;}
    }

    .btn{
      padding:12px 18px;border:none;border-radius:12px;
      font-size:13px;font-weight:900;cursor:pointer;
      transition:.15s;display:inline-flex;align-items:center;gap:8px;
    }
    .btn-primary{background:#3b82f6;color:white;}
    .btn-primary:hover{background:#2563eb;transform:translateY(-1px);}
    .btn-secondary{background:#e2e8f0;color:#0f172a;}
    .btn-secondary:hover{background:#cbd5e1;transform:translateY(-1px);}
    .btn-danger{
      background:#ef4444;color:white;padding:8px 12px;
      border-radius:10px;font-size:12px;font-weight:900;
    }
    .btn-danger:hover{background:#dc2626;transform:translateY(-1px);}
    .btn-ghost{
      background:transparent;border:1px solid #e2e8f0;color:#0f172a;
    }
    .btn-ghost:hover{background:#f8fafc;}

    .status-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:14px;
    }
    .status-card{
      border:1px solid #e2e8f0;background:#fff;border-radius:16px;
      padding:18px;cursor:pointer;transition:.15s;
    }
    .status-card:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(15,23,42,.10);}
    .status-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .status-title{font-weight:900;font-size:14px;}
    .status-meta{font-size:12px;color:#64748b;line-height:1.4;margin:8px 0;}
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;
      border:1px solid #e2e8f0;background:#f8fafc;color:#0f172a;
    }
    .pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46;}
    .pill.ng{background:#fef2f2;border-color:#fecaca;color:#7f1d1d;}

    .panel{
      background:#f8fafc;border:1px solid #e2e8f0;border-radius:16px;padding:20px;
    }
    .panel h3{font-size:16px;font-weight:900;margin-bottom:14px;display:flex;gap:8px;align-items:center;}
    .form-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:14px;
    }
    @media (min-width:1400px){.form-grid.wide{grid-template-columns:repeat(3,1fr);}}
    @media (max-width:768px){.form-grid{grid-template-columns:1fr;}}
    .form-group{display:flex;flex-direction:column;gap:8px;}
    .form-group label{font-size:13px;font-weight:900;color:#334155;}
    .form-group input,.form-group select{
      padding:11px 13px;border:1px solid #cbd5e1;border-radius:12px;
      font-size:14px;background:white;transition:.15s;
    }
    .form-group input:focus,.form-group select:focus{
      outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1);
    }
    .hint{font-size:12px;color:#64748b;line-height:1.4;margin-top:4px;}
    .kpi{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:14px;
    }
    .kpi-item{
      background:white;border:1px solid #e2e8f0;border-radius:14px;padding:16px;
    }
    .kpi-label{font-size:12px;color:#64748b;font-weight:800;}
    .kpi-value{font-size:20px;font-weight:1000;margin-top:6px;}

    .split{
      display:grid;grid-template-columns:520px 1fr;gap:18px;align-items:start;
    }
    @media (max-width:1200px){.split{grid-template-columns:1fr;}}

    .csv-zone{
      border:2px dashed #cbd5e1;border-radius:16px;
      padding:44px 24px;text-align:center;
      background:#f8fafc;cursor:pointer;transition:.15s;
    }
    .csv-zone:hover{border-color:#3b82f6;background:#eff6ff;}
    .csv-preview{
      margin-top:14px;background:white;border:1px solid #e2e8f0;border-radius:14px;padding:16px;
      max-height:520px;overflow:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th{
      position:sticky;top:0;background:#f1f5f9;
      text-align:left;padding:10px;border-bottom:2px solid #e2e8f0;font-weight:900;
    }
    td{padding:10px;border-bottom:1px solid #e2e8f0;}
    .muted{color:#64748b;}
    .danger{color:#ef4444;}
    .success{color:#10b981;}

    .item{
      background:white;border:1px solid #e2e8f0;border-radius:14px;padding:16px;
    }
    .item-head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;}
    .item-title{font-weight:1000;font-size:15px;}
    .item-sub{font-size:12px;color:#64748b;margin-top:5px;line-height:1.4;}
    .item-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;
      margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;
    }
    .mini-label{font-size:11px;color:#64748b;font-weight:900;text-transform:uppercase;}
    .mini-value{font-size:15px;font-weight:1000;margin-top:4px;}

    .profit-card{
      background:white;border:1px solid #e2e8f0;border-radius:16px;padding:20px;margin-top:12px;
    }
    .profit-card.danger{border-left:5px solid #ef4444;background:#fef2f2;}
    .profit-card.warning{border-left:5px solid #f59e0b;background:#fffbeb;}
    .profit-card.success{border-left:5px solid #10b981;background:#f0fdf4;}
    .profit-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap;}
    .profit-rate{
      padding:8px 14px;border-radius:12px;font-weight:1000;font-size:16px;color:white;
    }
    .profit-rate.danger{background:#ef4444;}
    .profit-rate.warning{background:#f59e0b;}
    .profit-rate.success{background:#10b981;}
    .warn{
      margin-top:12px;background:white;border:1px solid #fecaca;border-radius:12px;padding:12px;
      color:#7f1d1d;font-size:12px;line-height:1.5;
    }

    /* Loading */
    .loading{
      position:fixed;inset:0;background:rgba(15,23,42,.6);
      display:flex;justify-content:center;align-items:center;z-index:9999;
      backdrop-filter:blur(4px);
    }
    .loading-content{
      background:white;border-radius:18px;padding:28px 30px;text-align:center;
      border:1px solid #e2e8f0;box-shadow:0 20px 40px rgba(0,0,0,.2);
      width:min(420px,calc(100vw - 32px));
    }
    .spinner{
      border:4px solid #e2e8f0;border-top:4px solid #3b82f6;border-radius:50%;
      width:44px;height:44px;animation:spin 1s linear infinite;margin:0 auto 16px;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:10000;
      background:#0f172a;color:#fff;border-radius:16px;
      padding:14px 16px;border:1px solid rgba(255,255,255,.12);
      box-shadow:0 16px 34px rgba(0,0,0,.22);
      opacity:0;transform:translateY(10px);transition:.2s;
      width:min(420px,calc(100vw - 32px));
      font-size:13px;font-weight:900;line-height:1.4;
      display:flex;gap:10px;align-items:flex-start;
    }
    .toast.show{opacity:1;transform:translateY(0);}
    .toast .ticon{font-size:18px;line-height:1;}
    .toast-success{background:#065f46;border-color:#10b981;}
    .toast-danger{background:#7f1d1d;border-color:#ef4444;}
    .toast-warning{background:#92400e;border-color:#f59e0b;}
    .toast-info{background:#0f172a;}

    /* Inline alert */
    .inline-alert{
      background:#fff7ed;border:1px solid #fed7aa;border-radius:16px;
      padding:16px;color:#7c2d12;font-size:13px;font-weight:900;line-height:1.5;
      margin-top:14px;
    }

    /* Small anchors offset for sticky topbar */
    .anchor{scroll-margin-top:120px;}

    /* Input highlights */
    .highlight-box{
      border:2px solid #3b82f6;background:#eff6ff;border-radius:14px;
      padding:14px;margin-top:12px;
    }
    .highlight-box .item-title{color:#1e40af;}

    /* Better spacing */
    .section-gap{margin-top:24px;}
  </style>
</head>

<body>
  <div id="loading" class="loading" style="display:none;">
    <div class="loading-content">
      <div class="spinner"></div>
      <div id="loadingText" style="font-weight:1000;font-size:15px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div class="muted" style="margin-top:10px;font-size:12px;">é€šä¿¡çŠ¶æ³ã«ã‚ˆã‚Šå°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</div>
    </div>
  </div>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div style="font-size:22px;">ğŸ“Š</div>
        <div>
          <h1>å®Ÿç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  <span class="badge">v2.4</span></h1>
          <div class="sub">å£²ä¸Šãƒ»å‡¦åˆ†æ–™ã®ç®¡ç†ã¨ç²—åˆ©åˆ†æ</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <button class="tab" id="tab_dashboard" onclick="switchView('dashboard')" type="button">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="tab" id="tab_import" onclick="switchView('import')" type="button">ğŸ“¥ å£²ä¸ŠCSV</button>
        <button class="tab" id="tab_disposal" onclick="switchView('disposal')" type="button">ğŸ’° å‡¦åˆ†æ–™</button>
        <button class="tab" id="tab_analysis" onclick="switchView('analysis')" type="button">ğŸ“ˆ ç²—åˆ©</button>
      </div>

      <div class="right-controls">
        <select id="yearMonthSelector" class="month-selector" onchange="selectYearMonth(this.value)">
          <!-- JS -->
        </select>
        <button class="btn btn-ghost" type="button" onclick="refreshCurrent()">
          ğŸ”„ æ›´æ–°
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="content"><!-- JS --></div>
  </div>

  <script>
    // ========================================
    // è¨­å®š
    // ========================================
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbx-Oz89W5KU17zswb2i_AudaiYH0mpsA6MkcDr-Gg3_K1qpmkPBhxTMli0H_x347iEnpQ/exec'; // â†ã“ã“ã‚’å¤‰æ›´

    // ========================================
    // State
    // ========================================
    const state = {
      currentView: 'dashboard',
      selectedYearMonth: null,

      sales: [],
      disposalCosts: [],
      profitAnalysis: null,

      customers: [],
      wasteTypes: [],
      facilities: [],

      scrollToId: null,

      // å‡¦åˆ†æ–™å…¥åŠ›
      newDisposal: {
        facility: '',
        customerCode: '',
        wasteType: '',
        quantity: '',
        unit: 'kg',
        unitPrice: '',
        notes: ''
      },

      // ä¸€è¦§ãƒ•ã‚£ãƒ«ã‚¿
      listFilter: {
        q: '',
        facility: '',
        wasteType: ''
      },

      // CSVä¿æŒ
      currentCSV: null,
      currentCSVMeta: { detected: 0, errors: [] },

      lastCustomerCode: ''
    };

    // ========================================
    // èµ·å‹•
    // ========================================
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      console.log('ğŸš€ å®Ÿç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.4');
      showLoading('åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...');

      try {
        generateYearMonthSelector();

        const today = new Date();
        state.selectedYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('yearMonthSelector').value = state.selectedYearMonth;

        await Promise.all([loadCustomers(), loadWasteTypes(), loadFacilities()]);

        await loadSalesData(state.selectedYearMonth);
        await loadDisposalCosts(state.selectedYearMonth);

        state.profitAnalysis = null;
        render();
        toast('æº–å‚™OKï¼ä»Šæœˆã®å®Ÿç¸¾ã‚’ç¢ºèªã—ã‚ˆã†', 'success');
      } catch (e) {
        console.error(e);
        renderFatal(e);
      } finally {
        hideLoading();
      }
    }

    // ========================================
    // Utility
    // ========================================
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'èª­ã¿è¾¼ã¿ä¸­...';
      document.getElementById('loading').style.display = 'flex';
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function toast(message, type = 'info') {
      const el = document.createElement('div');
      el.className = `toast toast-${type}`;
      const icon = type === 'success' ? 'âœ…' : type === 'danger' ? 'âš ï¸' : type === 'warning' ? 'ğŸŸ ' : 'â„¹ï¸';
      el.innerHTML = `<div class="ticon">${icon}</div><div>${escapeHtml(message)}</div>`;
      document.body.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 200);
      }, 2600);
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function formatCurrency(num) {
      return 'Â¥' + (Number(num || 0)).toLocaleString('ja-JP');
    }
    function formatPercent(num) {
      return (Number(num || 0)).toFixed(1) + '%';
    }

    function setActiveTab(view) {
      const map = {
        dashboard: 'tab_dashboard',
        import: 'tab_import',
        disposal: 'tab_disposal',
        analysis: 'tab_analysis'
      };
      Object.values(map).forEach(id => document.getElementById(id)?.classList.remove('active'));
      const id = map[view];
      if (id) document.getElementById(id)?.classList.add('active');
    }

    function goTo(view, anchorId = null) {
      state.currentView = view;
      state.scrollToId = anchorId;
      render();
      setTimeout(() => {
        if (state.scrollToId) {
          const el = document.getElementById(state.scrollToId);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          state.scrollToId = null;
        }
      }, 0);
    }

    async function refreshCurrent() {
      showLoading('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
      try {
        await Promise.all([loadSalesData(state.selectedYearMonth), loadDisposalCosts(state.selectedYearMonth)]);
        state.profitAnalysis = null;
        render();
        toast('æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        toast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
      } finally {
        hideLoading();
      }
    }

    // ========================================
    // GAS API
    // ========================================
    async function callGAS(params) {
      if (!GAS_URL || GAS_URL.includes('ã‚ãªãŸã®GAS_URL')) {
        throw new Error('GAS_URL ãŒæœªè¨­å®šã§ã™ï¼ˆindex.html ã®å…ˆé ­ã§è¨­å®šã—ã¦ãã ã•ã„ï¼‰');
      }
      let res, text;
      try {
        res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(params) });
        text = await res.text();
      } catch (e) {
        throw new Error('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/URL/æ¨©é™ã‚’ç¢ºèªï¼‰');
      }

      let json;
      try {
        json = JSON.parse(text);
      } catch (e) {
        throw new Error('ã‚µãƒ¼ãƒãƒ¼å¿œç­”ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“: ' + text.slice(0, 120));
      }
      if (!json.success) {
        throw new Error(json.message || 'ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      return json;
    }

    async function loadCustomers() {
      const result = await callGAS({ action: 'getCustomers' });
      state.customers = result.data?.customers || [];
    }
    async function loadWasteTypes() {
      const result = await callGAS({ action: 'getWasteTypes' });
      state.wasteTypes = result.data || [];
    }
    async function loadFacilities() {
      const result = await callGAS({ action: 'getFacilities' });
      state.facilities = result.data || [];
    }
    async function loadSalesData(yearMonth) {
      const result = await callGAS({ action: 'getSalesData', yearMonth });
      state.sales = result.data || [];
    }
    async function loadDisposalCosts(yearMonth) {
      const result = await callGAS({ action: 'getDisposalCosts', yearMonth });
      state.disposalCosts = result.data || [];
    }

    async function importCSV(csvText) {
      showLoading('CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™...');
      try {
        const result = await callGAS({
          action: 'importSalesCSV',
          yearMonth: state.selectedYearMonth,
          csvData: csvText
        });
        const imported = result.imported || 0;
        const errors = result.errors || [];
        await loadSalesData(state.selectedYearMonth);
        state.profitAnalysis = null;
        goTo('dashboard', 'dashTop');
        if (errors.length) {
          toast(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼šæˆåŠŸ ${imported}ä»¶ / ã‚¨ãƒ©ãƒ¼ ${errors.length}ä»¶`, 'warning');
        } else {
          toast(`${imported}ä»¶ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
        }
      } catch (e) {
        toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
      } finally {
        hideLoading();
      }
    }

    async function saveDisposalCost(data) {
      showLoading('å‡¦åˆ†æ–™ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...');
      try {
        await callGAS({ action: 'saveDisposalCosts', data });
        await loadDisposalCosts(state.selectedYearMonth);

        // æ¬¡å…¥åŠ›ã‚’å¿«é©ã«
        state.lastCustomerCode = data.customerCode || state.lastCustomerCode;

        state.newDisposal = {
          facility: data.facility || state.newDisposal.facility,
          customerCode: state.lastCustomerCode || '',
          wasteType: '',
          quantity: '',
          unit: data.unit || 'kg',
          unitPrice: '',
          notes: ''
        };

        render();
        toast('æ˜ç´°ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
      } finally {
        hideLoading();
      }
    }

    async function saveGeneralDisposalCost(data) {
      showLoading('ä¸€èˆ¬å»ƒæ£„ç‰©å‡¦åˆ†æ–™ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...');
      try {
        await callGAS({ action: 'saveGeneralDisposalCost', data });
        await loadDisposalCosts(state.selectedYearMonth);
        state.profitAnalysis = null;
        render();
        toast('ä¸€èˆ¬å»ƒæ£„ç‰©ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        return true;
      } catch (e) {
        toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
        return false;
      } finally {
        hideLoading();
      }
    }

    async function deleteDisposalCost(id) {
      if (!confirm('ã“ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showLoading('å‰Šé™¤ã—ã¦ã„ã¾ã™...');
      try {
        await callGAS({ action: 'deleteDisposalCost', id });
        await loadDisposalCosts(state.selectedYearMonth);
        state.profitAnalysis = null;
        render();
        toast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        toast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
      } finally {
        hideLoading();
      }
    }

    async function calculateProfit() {
      showLoading('ç²—åˆ©ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™...');
      try {
        const result = await callGAS({ action: 'calculateProfitAnalysis', yearMonth: state.selectedYearMonth });
        state.profitAnalysis = result.data;
        render();
        toast('ç²—åˆ©ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      } catch (e) {
        toast('ç²—åˆ©è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
      } finally {
        hideLoading();
      }
    }

    // ========================================
    // å¹´æœˆã‚»ãƒ¬ã‚¯ã‚¿
    // ========================================
    function generateYearMonthSelector() {
      const selector = document.getElementById('yearMonthSelector');
      selector.innerHTML = '';
      const today = new Date();
      for (let i = 0; i < 24; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const label = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;
        selector.appendChild(option);
      }
    }

    async function selectYearMonth(yearMonth) {
      state.selectedYearMonth = yearMonth;
      state.profitAnalysis = null;
      showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
      try {
        await Promise.all([loadSalesData(yearMonth), loadDisposalCosts(yearMonth)]);
        render();
        toast(`${yearMonth} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'success');
      } catch (e) {
        toast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e), 'danger');
      } finally {
        hideLoading();
      }
    }

    // ========================================
    // Viewåˆ‡æ›¿
    // ========================================
    async function switchView(view) {
      state.currentView = view;

      // ç”»é¢åˆ‡æ›¿æ™‚ã®è»½ã„æ•´å‚™
      if (view === 'import') {
        state.currentCSV = null;
        state.currentCSVMeta = { detected: 0, errors: [] };
      }

      render();
    }

    // ========================================
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ========================================
    function render() {
      setActiveTab(state.currentView);

      const content = document.getElementById('content');
      if (!content) return;

      if (state.currentView === 'dashboard') content.innerHTML = renderDashboard();
      if (state.currentView === 'import') content.innerHTML = renderImport();
      if (state.currentView === 'disposal') content.innerHTML = renderDisposal();
      if (state.currentView === 'analysis') content.innerHTML = renderAnalysis();

      // ç”»é¢å†…ã§å¿…è¦ãªåŒæœŸï¼ˆè¡¨ç¤ºç›´å¾Œã®ãƒ©ãƒ™ãƒ«æ›´æ–°ãªã©ï¼‰
      if (state.currentView === 'disposal') {
        updateUnitPriceLabel();
        calculateTotal();
        if (state.newDisposal.customerCode) loadCustomerName(state.newDisposal.customerCode);
      }
    }

    function renderFatal(err) {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="card">
          <h2>âš ï¸ èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ</h2>
          <div class="subtitle">ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼šGAS_URL / æ¨©é™ / ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</div>
          <div class="inline-alert">
            ${escapeHtml(err?.message || err)}
          </div>
          <div style="margin-top:14px;">
            <button class="btn btn-primary" type="button" onclick="location.reload()">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
          </div>
        </div>
      `;
    }

    // ========================================
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    // ========================================
    function derived() {
      const hasSales = state.sales.length > 0;

      const generalCost = state.disposalCosts.find(c => c.wasteType === 'ä¸€èˆ¬å»ƒæ£„ç‰©') || null;
      const otherCosts = state.disposalCosts.filter(c => c.wasteType !== 'ä¸€èˆ¬å»ƒæ£„ç‰©');

      const hasGeneral = !!(generalCost && generalCost.quantity);
      const hasOther = otherCosts.length > 0;

      const hasAnalysis = state.profitAnalysis !== null;

      return { hasSales, generalCost, otherCosts, hasGeneral, hasOther, hasAnalysis };
    }

    function renderDashboard() {
      const { hasSales, generalCost, otherCosts, hasGeneral, hasOther, hasAnalysis } = derived();

      return `
        <div id="dashTop" class="anchor"></div>

        <div class="card">
          <h2>ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
          <div class="subtitle">
            å¯¾è±¡å¹´æœˆï¼š<b>${escapeHtml(state.selectedYearMonth)}</b>
            <span class="muted">ï¼ˆè¶³ã‚Šãªã„ã¨ã“ã‚ã‹ã‚‰åŸ‹ã‚ã¦ã€æœ€å¾Œã«ç²—åˆ©ï¼‰</span>
          </div>

          <div class="status-grid">
            ${renderStatusCard({
              title: 'å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰',
              icon: 'ğŸ“¥',
              ok: hasSales,
              meta: hasSales ? `${state.sales.length}ä»¶ ç™»éŒ²æ¸ˆã¿` : 'æœªç™»éŒ²',
              onClick: `goTo('import','importTop')`,
              action: hasSales ? 'è¦‹ã‚‹' : 'å–ã‚Šè¾¼ã‚€'
            })}
            ${renderStatusCard({
              title: 'ä¸€èˆ¬å»ƒæ£„ç‰©ï¼ˆæœˆæ¬¡ä¸€æ‹¬ï¼‰',
              icon: 'ğŸ—‘ï¸',
              ok: hasGeneral,
              meta: hasGeneral ? `${Number(generalCost.quantity||0).toLocaleString()} ${escapeHtml(generalCost.unit||'kg')} / ${formatCurrency(generalCost.totalCost||0)}` : 'æœªç™»éŒ²',
              onClick: `goTo('disposal','generalSection')`,
              action: hasGeneral ? 'ç¢ºèª/æ›´æ–°' : 'å…¥åŠ›ã™ã‚‹'
            })}
            ${renderStatusCard({
              title: 'å»ºç”£å»ƒï¼ˆæ˜ç´°ï¼‰',
              icon: 'ğŸ­',
              ok: hasOther,
              meta: hasOther ? `${otherCosts.length}ä»¶ ç™»éŒ²æ¸ˆã¿` : 'æœªç™»éŒ²',
              onClick: `goTo('disposal','otherSection')`,
              action: hasOther ? 'ä¸€è¦§ã‚’è¦‹ã‚‹' : 'å…¥åŠ›ã™ã‚‹'
            })}
            ${renderStatusCard({
              title: 'ç²—åˆ©ï¼ˆã‚«ãƒ†ã‚´ãƒª/é¡§å®¢ï¼‰',
              icon: 'ğŸ“ˆ',
              ok: hasAnalysis,
              meta: hasAnalysis ? 'è¨ˆç®—æ¸ˆã¿' : 'æœªè¨ˆç®—',
              onClick: `goTo('analysis','analysisTop')`,
              action: hasAnalysis ? 'è¦‹ã‚‹' : 'è¨ˆç®—ã™ã‚‹'
            })}
          </div>

          <div class="kpi">
            <div class="kpi-item">
              <div class="kpi-label">å£²ä¸Šåˆè¨ˆï¼ˆå½“æœˆï¼‰</div>
              <div class="kpi-value">${formatCurrency(sumSalesAll())}</div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label">å‡¦åˆ†æ–™åˆè¨ˆï¼ˆå½“æœˆï¼‰</div>
              <div class="kpi-value">${formatCurrency(sumCostsAll())}</div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label">ç²—åˆ©è¦‹è¾¼ã¿ï¼ˆå½“æœˆï¼‰</div>
              <div class="kpi-value">${formatCurrency(sumSalesAll() - sumCostsAll())}</div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label">ç²—åˆ©ç‡è¦‹è¾¼ã¿</div>
              <div class="kpi-value">${formatPercent( sumSalesAll() > 0 ? ((sumSalesAll()-sumCostsAll())/sumSalesAll())*100 : 0 )}</div>
            </div>
          </div>

          ${(!hasSales && !hasGeneral && !hasOther) ? `
            <div class="panel section-gap">
              <h3>ğŸš€ ã¯ã˜ã‚ã¦ã®æ‰‹é †</h3>
              <div class="hint">
                â‘  å£²ä¸Šã‚’CSVã§å–ã‚Šè¾¼ã¿ â†’ â‘¡ ä¸€èˆ¬å»ƒæ£„ç‰©ã‚’æœˆæ¬¡ã§å…¥åŠ› â†’ â‘¢ å»ºç”£å»ƒã®æ˜ç´°ã‚’å…¥åŠ› â†’ â‘£ ç²—åˆ©ã‚’è¦‹ã‚‹<br/>
                â€» ä¸€èˆ¬ã¯æŒ‰åˆ†ã›ãšã€Œã‚«ãƒ†ã‚´ãƒªç²—åˆ©ã€ã§OKï¼ˆã„ã¾ã®è¨­è¨ˆã§æ­£è§£ï¼‰
              </div>
              <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="goTo('import','importTop')" type="button">ğŸ“¥ ã¾ãšCSVã‚’å–ã‚Šè¾¼ã‚€</button>
                <button class="btn btn-secondary" onclick="goTo('disposal','generalSection')" type="button">ğŸ—‘ï¸ ä¸€èˆ¬ã‚’å…¥åŠ›</button>
              </div>
            </div>
          ` : ``}
        </div>
      `;
    }

    function renderStatusCard({ title, icon, ok, meta, onClick, action }) {
      return `
        <div class="status-card" onclick="${onClick}">
          <div class="status-top">
            <div class="status-title">${icon} ${escapeHtml(title)}</div>
            <div class="pill ${ok ? 'ok' : 'ng'}">${ok ? 'OK' : 'æœª'}</div>
          </div>
          <div class="status-meta">${escapeHtml(meta)}</div>
          <div style="margin-top:14px;">
            <span class="btn btn-ghost" style="pointer-events:none;padding:8px 12px;border-radius:999px;font-size:12px;">
              ğŸ‘‰ ${escapeHtml(action)}
            </span>
          </div>
        </div>
      `;
    }

    function sumSalesAll() {
      let total = 0;
      for (const s of state.sales || []) {
        const v = Number(s.total ?? s.amount ?? s.sales ?? s.totalSales ?? 0);
        if (!Number.isNaN(v)) total += v;
      }
      return total;
    }

    function sumCostsAll() {
      let total = 0;
      for (const c of state.disposalCosts || []) {
        const v = Number(c.totalCost ?? ((Number(c.quantity||0))*(Number(c.unitPrice||0))) ?? 0);
        if (!Number.isNaN(v)) total += v;
      }
      return total;
    }

    // ========================================
    // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    // ========================================
    function renderImport() {
      return `
        <div id="importTop" class="anchor"></div>

        <div class="card">
          <h2>ğŸ“¥ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰</h2>
          <div class="subtitle">
            å¯¾è±¡å¹´æœˆï¼š<b>${escapeHtml(state.selectedYearMonth)}</b><br/>
            <span class="muted">â€» æ—¢å­˜ã®åŒæœˆãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™</span>
          </div>

          <div class="csv-zone" onclick="document.getElementById('csvFile').click()">
            <div style="font-size:52px;margin-bottom:10px;">ğŸ“„</div>
            <div style="font-size:16px;font-weight:1000;margin-bottom:6px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
            <div class="muted" style="font-size:13px;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleCSV(event)" />
          </div>

          <div id="csvPreviewArea"></div>

          <div class="panel section-gap">
            <h3>ğŸ“‹ CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹ï¼‰</h3>
            <pre style="background:white;border:1px solid #e2e8f0;border-radius:14px;padding:14px;overflow:auto;font-size:12px;line-height:1.6;">ã‚³ãƒ¼ãƒ‰,é¡§å®¢å,æœˆæ¥µ,ä¸€èˆ¬ã¥,ç²—å¤§,ãƒ€ãƒ³ãƒœãƒ¼ãƒ«,ç”£å»ƒ,å¾ªç’°ç¨,å»ºå»ƒ,å»ƒå®¶é›»,ãƒ—ãƒªãƒšã‚¤ãƒ‰+é‡‘å±
1100,ä½è—¤å•†åº—,10000,0,0,0,0,0,0,0,0
1101,éˆ´æœ¨å•†äº‹,0,0,0,5000,0,0,0,0,0</pre>
            <div class="hint" style="margin-top:12px;">
              â€» é¡§å®¢åã¯çœç•¥å¯èƒ½ï¼ˆé¡§å®¢ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰<br/>
              â€» æ–‡å­—åŒ–ã‘ã™ã‚‹å ´åˆã¯ã€Excelå´ã§ã€ŒCSV UTF-8ã€ã§ä¿å­˜ã—ã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„
            </div>
          </div>
        </div>
      `;
    }

    function handleCSV(event) {
      const file = event.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        if (looksBroken(text)) {
          // Shift_JISã§å¤±æ•—ã£ã½ã„ãªã‚‰UTF-8ã§èª­ã¿ç›´ã™
          const reader2 = new FileReader();
          reader2.onload = (e2) => {
            displayCSVPreview(e2.target.result);
            toast('UTF-8ã§èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'info');
          };
          reader2.readAsText(file, 'UTF-8');
        } else {
          displayCSVPreview(text);
        }
      };

      // ã¾ãšShift_JISã‚’è©¦ã™ï¼ˆå®Ÿå‹™Excelæƒ³å®šï¼‰
      reader.readAsText(file, 'Shift_JIS');
    }

    function looksBroken(text) {
      const s = String(text || '');
      const bad = (s.match(/\uFFFD/g) || []).length;
      return bad >= 10;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function displayCSVPreview(csvText) {
      state.currentCSV = csvText;
      state.currentCSVMeta = { detected: 0, errors: [] };

      const lines = String(csvText || '').split('\n').map(l => l.replace(/\r/g, '')).filter(l => l.trim().length);
      const preview = document.getElementById('csvPreviewArea');
      if (!preview) return;

      if (!lines.length) {
        preview.innerHTML = `<div class="inline-alert">CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™</div>`;
        return;
      }

      const dataLines = [];
      for (let i = 0; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols[0] && /^\d{4}/.test(cols[0].trim())) dataLines.push(lines[i]);
      }

      if (!dataLines.length) {
        preview.innerHTML = `<div class="inline-alert">æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆå…ˆé ­ãŒ4æ¡ã‚³ãƒ¼ãƒ‰ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>`;
        return;
      }

      // ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
      const errors = [];
      for (let i = 0; i < Math.min(dataLines.length, 200); i++) {
        const cols = parseCSVLine(dataLines[i]);
        const code = (cols[0] || '').trim();
        const numericIdx = [5,6,7,9,10,11,12,13,14];
        for (const idx of numericIdx) {
          const v = (cols[idx] ?? '0').trim();
          if (v && v !== '0' && isNaN(Number(v))) {
            errors.push(`ã‚³ãƒ¼ãƒ‰${code}: æ•°å€¤ã§ãªã„å€¤ã€Œ${v}ã€(åˆ—${idx+1})`);
            if (errors.length >= 10) break;
          }
        }
        if (errors.length >= 10) break;
      }

      state.currentCSVMeta.detected = dataLines.length;
      state.currentCSVMeta.errors = errors;

      let html = `
        <div class="csv-preview">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <div style="font-weight:1000;">
              æ¤œå‡ºï¼š<span style="font-size:16px;color:#3b82f6;">${dataLines.length}ä»¶</span>
              ${errors.length ? `<span class="muted" style="margin-left:10px;">ï¼ˆæ³¨æ„ï¼šãƒã‚§ãƒƒã‚¯è­¦å‘Š ${errors.length}ä»¶ï¼‰</span>` : ``}
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-secondary" type="button" onclick="clearCSV()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
              <button class="btn btn-primary" type="button" onclick="executeImport()">âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
            </div>
          </div>

          ${errors.length ? `
            <div class="inline-alert" style="margin-top:12px;">
              <div style="margin-bottom:6px;">ğŸŸ  äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆå…ˆé ­10ä»¶ã¾ã§è¡¨ç¤ºï¼‰</div>
              <ul style="margin-left:18px;">
                ${errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
              </ul>
            </div>
          ` : ``}

          <div style="margin-top:14px;overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>ã‚³ãƒ¼ãƒ‰</th><th>é¡§å®¢å</th><th>æœˆæ¥µ</th><th>ä¸€èˆ¬ã¥</th><th>ç²—å¤§</th>
                  <th>ãƒ€ãƒ³ãƒœãƒ¼ãƒ«</th><th>ç”£å»ƒ</th><th>å¾ªç’°ç¨</th><th>å»ºå»ƒ</th><th>å»ƒå®¶é›»</th><th>ãƒ—ãƒªãƒšã‚¤ãƒ‰</th>
                </tr>
              </thead>
              <tbody>
      `;

      for (let i = 0; i < Math.min(dataLines.length, 20); i++) {
        const cols = parseCSVLine(dataLines[i]);

        const code = cols[0] || '';
        const name = cols[3] || '';
        const monthlyFee = cols[5] || '0';
        const cubic = cols[6] || '0';
        const large = cols[7] || '0';
        const cardboard = cols[9] || '0';
        const industrial = cols[10] || '0';
        const recycle = cols[11] || '0';
        const construction = cols[12] || '0';
        const appliance = cols[13] || '0';
        const prepaid = cols[14] || '0';

        html += `
          <tr>
            <td>${escapeHtml(code)}</td>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(monthlyFee)}</td>
            <td>${escapeHtml(cubic)}</td>
            <td>${escapeHtml(large)}</td>
            <td>${escapeHtml(cardboard)}</td>
            <td>${escapeHtml(industrial)}</td>
            <td>${escapeHtml(recycle)}</td>
            <td>${escapeHtml(construction)}</td>
            <td>${escapeHtml(appliance)}</td>
            <td>${escapeHtml(prepaid)}</td>
          </tr>
        `;
      }

      if (dataLines.length > 20) {
        html += `<tr><td colspan="11" class="muted" style="text-align:center;">...ä»– ${dataLines.length - 20}ä»¶</td></tr>`;
      }

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;

      preview.innerHTML = html;
    }

    function clearCSV() {
      state.currentCSV = null;
      state.currentCSVMeta = { detected: 0, errors: [] };
      const preview = document.getElementById('csvPreviewArea');
      if (preview) preview.innerHTML = '';
      const input = document.getElementById('csvFile');
      if (input) input.value = '';
      toast('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    }

    async function executeImport() {
      if (!state.currentCSV) return;
      const msg =
        `${state.selectedYearMonth} ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\n` +
        `æ—¢å­˜ã®åŒæœˆãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
      if (!confirm(msg)) return;
      await importCSV(state.currentCSV);
    }

    // ========================================
    // å‡¦åˆ†æ–™
    // ========================================
    function renderDisposal() {
      const generalCost = state.disposalCosts.find(c => c.wasteType === 'ä¸€èˆ¬å»ƒæ£„ç‰©') || {};
      const otherCostsRaw = state.disposalCosts.filter(c => c.wasteType !== 'ä¸€èˆ¬å»ƒæ£„ç‰©');

      // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
      const q = (state.listFilter.q || '').trim().toLowerCase();
      const fac = (state.listFilter.facility || '').trim();
      const wt = (state.listFilter.wasteType || '').trim();

      const otherCosts = otherCostsRaw.filter(c => {
        const hay = `${c.customerCode||''} ${c.customerName||''} ${c.facility||''} ${c.wasteType||''}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (fac && (c.facility||'') !== fac) return false;
        if (wt && (c.wasteType||'') !== wt) return false;
        return true;
      });

      const otherTotal = otherCostsRaw.reduce((sum,c)=>sum + Number(c.totalCost ?? (Number(c.quantity||0)*Number(c.unitPrice||0)) ?? 0), 0);
      const otherCount = otherCostsRaw.length;

      return `
        <div class="card">
          <h2>ğŸ’° å‡¦åˆ†æ–™ï¼ˆä¸€èˆ¬ï¼‹å»ºç”£å»ƒï¼‰</h2>
          <div class="subtitle">
            ä¸€èˆ¬ã¯æœˆæ¬¡ä¸€æ‹¬ï¼å»ºç”£å»ƒï¼ˆç”£å»ƒï¼‹å»ºå»ƒï¼‰ã¯æ˜ç´°ã§ç™»éŒ²ã—ã¾ã™ã€‚
          </div>

          <div class="split">
            <!-- å·¦ï¼šå…¥åŠ› -->
            <div>
              <div id="generalSection" class="anchor"></div>
              <div class="panel">
                <h3>ğŸ—‘ï¸ ä¸€èˆ¬å»ƒæ£„ç‰©ï¼ˆæœˆæ¬¡ä¸€æ‹¬ï¼‰</h3>

                ${generalCost.quantity ? `
                  <div class="highlight-box" style="margin-bottom:14px;">
                    <div class="item-title">ğŸ“Œ ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿</div>
                    <div class="item-sub" style="margin-top:6px;">
                      å‡¦åˆ†å ´ï¼š${escapeHtml(generalCost.facility||'-')}<br/>
                      æ¬å…¥é‡ï¼š${Number(generalCost.quantity||0).toLocaleString()} ${escapeHtml(generalCost.unit||'kg')}<br/>
                      å‡¦åˆ†æ–™ï¼š${formatCurrency(generalCost.totalCost||0)}<br/>
                      å˜ä¾¡ï¼š${formatCurrency((Number(generalCost.totalCost||0) / Math.max(Number(generalCost.quantity||0),1)).toFixed(2))}/${escapeHtml(generalCost.unit||'kg')}
                    </div>
                  </div>
                ` : ``}

                <div class="form-grid wide">
                  <div class="form-group">
                    <label>ç·æ¬å…¥é‡ <span class="danger">*</span></label>
                    <input type="number" id="general_quantity" value="${escapeHtml(generalCost.quantity||'')}" placeholder="8000" step="0.01" />
                  </div>
                  <div class="form-group">
                    <label>å˜ä½ <span class="danger">*</span></label>
                    <select id="general_unit">
                      <option value="kg" ${(generalCost.unit || 'kg') === 'kg' ? 'selected' : ''}>kg</option>
                      <option value="ã¥" ${generalCost.unit === 'ã¥' ? 'selected' : ''}>ã¥</option>
                      <option value="å°" ${generalCost.unit === 'å°' ? 'selected' : ''}>å°</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>ç·å‡¦åˆ†æ–™ï¼ˆå††ï¼‰ <span class="danger">*</span></label>
                    <input type="number" id="general_cost" value="${escapeHtml(generalCost.totalCost||'')}" placeholder="200000" />
                  </div>
                  <div class="form-group" style="grid-column:1/-1;">
                    <label>å‡¦åˆ†å ´ <span class="danger">*</span></label>
                    <input type="text" id="general_facility" value="${escapeHtml(generalCost.facility||'')}" placeholder="è§’å±±é–‹ç™º" list="generalFacilityList" />
                    <datalist id="generalFacilityList">
                      ${(state.facilities||[]).map(f => `<option value="${escapeHtml(f.name)}">${escapeHtml(f.name)}</option>`).join('')}
                    </datalist>
                    <div class="hint">ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã€ã¾ãŸã¯è‡ªç”±å…¥åŠ›OK</div>
                  </div>
                  <div class="form-group" style="grid-column:1/-1;">
                    <label>å‚™è€ƒ</label>
                    <input type="text" id="general_notes" value="${escapeHtml(generalCost.notes||'')}" placeholder="å‚™è€ƒï¼ˆä»»æ„ï¼‰" />
                  </div>
                </div>

                <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
                  <button class="btn btn-primary" type="button" onclick="saveGeneral()">
                    âœ… ${generalCost.quantity ? 'æ›´æ–°' : 'ä¿å­˜'}
                  </button>
                  <button class="btn btn-secondary" type="button" onclick="goTo('dashboard','dashTop')">ğŸ  æˆ»ã‚‹</button>
                </div>

                <div class="hint" style="margin-top:12px;">
                  ğŸ’¡ ä¸€èˆ¬å»ƒæ£„ç‰©ã¯æŒ‰åˆ†ã›ãšã€ã‚«ãƒ†ã‚´ãƒªç²—åˆ©ã§ç®¡ç†ï¼ˆå®Ÿå‹™ã«åˆã†è¨­è¨ˆï¼‰
                </div>
              </div>

              <div id="otherSection" class="anchor section-gap"></div>
              <div class="panel">
                <h3>ğŸ­ å»ºç”£å»ƒï¼ˆæ˜ç´°å…¥åŠ›ï¼‰</h3>

                <div class="form-grid">
                  <div class="form-group" style="grid-column:1/-1;">
                    <label>å‡¦åˆ†å ´ <span class="danger">*</span></label>
                    <input type="text" id="new_facility" value="${escapeHtml(state.newDisposal.facility)}"
                      onchange="updateNewDisposal('facility', this.value)"
                      placeholder="è§’å±±é–‹ç™º" list="facilityList" />
                    <datalist id="facilityList">
                      ${(state.facilities||[]).map(f => `<option value="${escapeHtml(f.name)}">${escapeHtml(f.name)}</option>`).join('')}
                    </datalist>
                    <div class="hint">ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã€ã¾ãŸã¯è‡ªç”±å…¥åŠ›OK</div>
                  </div>

                  <div class="form-group">
                    <label>é¡§å®¢ã‚³ãƒ¼ãƒ‰ <span class="danger">*</span></label>
                    <input type="text" id="new_customerCode"
                      value="${escapeHtml(state.newDisposal.customerCode)}"
                      onchange="updateNewDisposal('customerCode', this.value)"
                      onblur="loadCustomerName(this.value)"
                      placeholder="1100" list="customerCodes" />
                    <datalist id="customerCodes">
                      ${buildCustomerCodeOptions()}
                    </datalist>
                    <div class="hint">å€™è£œãŒå‡ºã¾ã™</div>
                  </div>

                  <div class="form-group">
                    <label>å»ƒæ£„ç‰©ç¨®é¡ <span class="danger">*</span></label>
                    <input type="text" id="new_wasteType"
                      value="${escapeHtml(state.newDisposal.wasteType)}"
                      onchange="updateNewDisposal('wasteType', this.value); loadDefaultUnitPrice(this.value, document.getElementById('new_customerCode').value)"
                      placeholder="æ··åˆå»ƒæ£„ç‰©ï¼ˆç”£å»ƒï¼‰" list="wasteTypeList" />
                    <datalist id="wasteTypeList">
                      ${(state.wasteTypes||[]).filter(w => w.category !== 'general').map(w => `<option value="${escapeHtml(w.name)}">${escapeHtml(w.name)}</option>`).join('')}
                    </datalist>
                    <div class="hint">é¸æŠã¾ãŸã¯è‡ªç”±å…¥åŠ›</div>
                  </div>

                  <div class="form-group">
                    <label>æ•°é‡ <span class="danger">*</span></label>
                    <input type="number" id="new_quantity" value="${escapeHtml(state.newDisposal.quantity)}"
                      onchange="updateNewDisposal('quantity', this.value); calculateTotal()"
                      placeholder="500" step="0.01" />
                  </div>

                  <div class="form-group">
                    <label>å˜ä½ <span class="danger">*</span></label>
                    <select id="new_unit" onchange="updateNewDisposal('unit', this.value); updateUnitPriceLabel(); calculateTotal();">
                      ${['kg','ã¥','å°','æš','æœ¬','å€‹'].map(u => `<option value="${u}" ${state.newDisposal.unit===u?'selected':''}>${u}</option>`).join('')}
                    </select>
                  </div>

                  <div class="form-group">
                    <label id="unitPriceLabel">å˜ä¾¡ï¼ˆå††/${escapeHtml(state.newDisposal.unit)}ï¼‰ <span class="danger">*</span></label>
                    <input type="number" id="new_unitPrice" value="${escapeHtml(state.newDisposal.unitPrice)}"
                      onchange="updateNewDisposal('unitPrice', this.value); calculateTotal()"
                      placeholder="30" step="0.01" />
                  </div>

                  <div class="form-group" style="grid-column:1/-1;">
                    <label>å‚™è€ƒ</label>
                    <input type="text" id="new_notes" value="${escapeHtml(state.newDisposal.notes)}"
                      onchange="updateNewDisposal('notes', this.value)"
                      placeholder="å‚™è€ƒï¼ˆä»»æ„ï¼‰" />
                  </div>
                </div>

                <div id="customerNameDisplay" style="margin-top:12px;display:none;">
                  <div class="item" style="border-color:#bfdbfe;background:#eff6ff;">
                    <div class="item-title">ğŸ‘¤ é¡§å®¢åï¼š<span id="customerNameText"></span></div>
                  </div>
                </div>

                <div id="totalCostDisplay" style="margin-top:12px;display:none;">
                  <div class="highlight-box">
                    <div class="item-title">åˆè¨ˆé‡‘é¡ï¼š<span id="totalCostText"></span></div>
                    <div class="hint" style="margin-top:4px;">æ•°é‡ Ã— å˜ä¾¡</div>
                  </div>
                </div>

                <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
                  <button class="btn btn-primary" type="button" onclick="addNewDisposal()">âœ… ç™»éŒ²</button>
                  <button class="btn btn-secondary" type="button" onclick="resetNewDisposal()">ğŸ§¹ å…¥åŠ›ã‚¯ãƒªã‚¢</button>
                </div>
              </div>
            </div>

            <!-- å³ï¼šä¸€è¦§ -->
            <div>
              <div class="panel">
                <h3>ğŸ“‹ å»ºç”£å»ƒ æ˜ç´°ä¸€è¦§</h3>

                <div class="form-grid" style="margin-bottom:12px;">
                  <div class="form-group" style="grid-column:1/-1;">
                    <label>æ¤œç´¢ï¼ˆé¡§å®¢/å‡¦åˆ†å ´/å»ƒæ£„ç‰©/ã‚³ãƒ¼ãƒ‰ï¼‰</label>
                    <input type="text" value="${escapeHtml(state.listFilter.q)}"
                      oninput="updateListFilter('q', this.value)"
                      placeholder="ä¾‹ï¼š1100 / ä½è—¤ / è§’å±± / æ··åˆ" />
                  </div>
                  <div class="form-group">
                    <label>å‡¦åˆ†å ´ã§çµã‚Šè¾¼ã¿</label>
                    <select onchange="updateListFilter('facility', this.value)">
                      <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
                      ${uniqueFacilities(otherCostsRaw).map(f => `<option value="${escapeHtml(f)}" ${state.listFilter.facility===f?'selected':''}>${escapeHtml(f)}</option>`).join('')}
                    </select>
                  </div>
                  <div class="form-group">
                    <label>å»ƒæ£„ç‰©ç¨®é¡ã§çµã‚Šè¾¼ã¿</label>
                    <select onchange="updateListFilter('wasteType', this.value)">
                      <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
                      ${uniqueWasteTypes(otherCostsRaw).map(w => `<option value="${escapeHtml(w)}" ${state.listFilter.wasteType===w?'selected':''}>${escapeHtml(w)}</option>`).join('')}
                    </select>
                  </div>
                </div>

                <div class="item" style="margin-bottom:12px;background:#f8fafc;">
                  <div class="item-grid">
                    <div>
                      <div class="mini-label">å…¨ä»¶æ•°</div>
                      <div class="mini-value">${otherCount}ä»¶</div>
                    </div>
                    <div>
                      <div class="mini-label">è¡¨ç¤ºä¸­</div>
                      <div class="mini-value">${otherCosts.length}ä»¶</div>
                    </div>
                    <div>
                      <div class="mini-label">åˆè¨ˆé‡‘é¡</div>
                      <div class="mini-value">${formatCurrency(otherTotal)}</div>
                    </div>
                  </div>
                </div>

                <div style="margin-bottom:12px;">
                  <button class="btn btn-ghost" type="button" onclick="clearListFilter()" style="width:100%;">ğŸ§¹ çµã‚Šè¾¼ã¿è§£é™¤</button>
                </div>

                ${otherCosts.length === 0 ? `
                  <div class="item" style="text-align:center;padding:24px;">
                    <div class="muted">è©²å½“ã™ã‚‹æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“</div>
                  </div>
                ` : `
                  <div class="grid">
                    ${otherCosts.map(cost => renderDisposalItem(cost)).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function buildCustomerCodeOptions() {
      const list = [
        ...(state.customers||[]).map(c => ({ code: c.code, name: c.name })),
        ...(state.sales||[]).map(s => ({ code: s.customerCode, name: s.customerName }))
      ]
        .filter(v => v.code)
        .filter((v, i, a) => a.findIndex(t => t.code === v.code) === i)
        .sort((a, b) => String(a.code).localeCompare(String(b.code)));

      return list.map(c => `<option value="${escapeHtml(c.code)}">${escapeHtml(c.name || '')}</option>`).join('');
    }

    function uniqueFacilities(costs) {
      const s = new Set();
      for (const c of costs || []) if (c.facility) s.add(c.facility);
      return Array.from(s).sort((a,b)=>String(a).localeCompare(String(b)));
    }
    function uniqueWasteTypes(costs) {
      const s = new Set();
      for (const c of costs || []) if (c.wasteType) s.add(c.wasteType);
      return Array.from(s).sort((a,b)=>String(a).localeCompare(String(b)));
    }

    function renderDisposalItem(cost) {
      const unit = cost.unit || 'kg';
      const totalCost = Number(cost.totalCost ?? (Number(cost.quantity||0)*Number(cost.unitPrice||0)) ?? 0);
      return `
        <div class="item">
          <div class="item-head">
            <div>
              <div class="item-title">${escapeHtml(cost.customerName || cost.customerCode || '-')}</div>
              <div class="item-sub">
                ${escapeHtml(cost.customerCode || '')} / ${escapeHtml(cost.facility || '-')} / ${escapeHtml(cost.wasteType || '-')}
              </div>
            </div>
            <button class="btn-danger" type="button" onclick="deleteDisposalCost('${escapeHtml(cost.id)}')">å‰Šé™¤</button>
          </div>

          <div class="item-grid">
            <div>
              <div class="mini-label">æ•°é‡</div>
              <div class="mini-value">${Number(cost.quantity||0).toLocaleString()} ${escapeHtml(unit)}</div>
            </div>
            <div>
              <div class="mini-label">å˜ä¾¡</div>
              <div class="mini-value">${formatCurrency(cost.unitPrice||0)}/${escapeHtml(unit)}</div>
            </div>
            <div>
              <div class="mini-label">åˆè¨ˆ</div>
              <div class="mini-value" style="color:#2563eb;">${formatCurrency(totalCost)}</div>
            </div>
          </div>

          ${cost.notes ? `
            <div class="hint" style="margin-top:10px;">ğŸ“ ${escapeHtml(cost.notes)}</div>
          ` : ``}
        </div>
      `;
    }

    function updateNewDisposal(field, value) {
      state.newDisposal[field] = value;
    }

    function resetNewDisposal() {
      const keepFacility = state.newDisposal.facility || '';
      const keepCustomer = state.lastCustomerCode || state.newDisposal.customerCode || '';
      state.newDisposal = {
        facility: keepFacility,
        customerCode: keepCustomer,
        wasteType: '',
        quantity: '',
        unit: 'kg',
        unitPrice: '',
        notes: ''
      };
      render();
      toast('å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    }

    function updateUnitPriceLabel() {
      const unit = state.newDisposal.unit || 'kg';
      const label = document.getElementById('unitPriceLabel');
      if (label) label.innerHTML = `å˜ä¾¡ï¼ˆå††/${escapeHtml(unit)}ï¼‰ <span class="danger">*</span>`;
    }

    function loadCustomerName(code) {
      let customer = (state.customers||[]).find(c => c.code === code);
      if (!customer) {
        const sale = (state.sales||[]).find(s => s.customerCode === code);
        if (sale) customer = { code, name: sale.customerName };
      }
      const box = document.getElementById('customerNameDisplay');
      const text = document.getElementById('customerNameText');
      if (customer && customer.name && box && text) {
        box.style.display = 'block';
        text.textContent = customer.name;
      } else if (box) {
        box.style.display = 'none';
      }
    }

    function loadDefaultUnitPrice(wasteTypeName, customerCode) {
      const pastCost = (state.disposalCosts||[]).find(c =>
        c.customerCode === customerCode && c.wasteType === wasteTypeName
      );
      const input = document.getElementById('new_unitPrice');

      if (pastCost && pastCost.unitPrice) {
        state.newDisposal.unitPrice = pastCost.unitPrice;
        if (input) input.value = pastCost.unitPrice;
      } else {
        const wasteType = (state.wasteTypes||[]).find(w => w.name === wasteTypeName);
        if (wasteType && wasteType.defaultUnitPrice) {
          state.newDisposal.unitPrice = wasteType.defaultUnitPrice;
          if (input) input.value = wasteType.defaultUnitPrice;
        }
      }
      calculateTotal();
    }

    function calculateTotal() {
      const quantity = parseFloat(state.newDisposal.quantity) || 0;
      const unitPrice = parseFloat(state.newDisposal.unitPrice) || 0;
      const total = quantity * unitPrice;

      const box = document.getElementById('totalCostDisplay');
      const text = document.getElementById('totalCostText');

      if (total > 0 && box && text) {
        box.style.display = 'block';
        text.textContent = 'Â¥' + total.toLocaleString('ja-JP');
      } else if (box) {
        box.style.display = 'none';
      }
    }

    async function addNewDisposal() {
      const d = state.newDisposal;
      const facility = (d.facility || '').trim();
      const customerCode = (d.customerCode || '').trim();
      const wasteType = (d.wasteType || '').trim();
      const quantity = parseFloat(d.quantity);
      const unit = d.unit || 'kg';
      const unitPrice = parseFloat(d.unitPrice);
      const notes = (d.notes || '').trim();

      if (!facility) return toast('å‡¦åˆ†å ´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
      if (!customerCode) return toast('é¡§å®¢ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
      if (!wasteType) return toast('å»ƒæ£„ç‰©ç¨®é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
      if (!quantity || quantity <= 0) return toast('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
      if (!unitPrice || unitPrice <= 0) return toast('å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');

      let customer = (state.customers||[]).find(c => c.code === customerCode);
      if (!customer) {
        const sale = (state.sales||[]).find(s => s.customerCode === customerCode);
        if (sale) customer = { code: customerCode, name: sale.customerName };
      }
      const customerName = customer?.name || customerCode;

      const totalCost = quantity * unitPrice;

      await saveDisposalCost({
        yearMonth: state.selectedYearMonth,
        facility,
        customerCode,
        customerName,
        wasteType,
        quantity,
        unit,
        unitPrice,
        totalCost,
        notes
      });
    }

    async function saveGeneral() {
      const quantity = parseFloat(document.getElementById('general_quantity')?.value);
      const cost = parseFloat(document.getElementById('general_cost')?.value);
      const facility = (document.getElementById('general_facility')?.value || '').trim();
      const notes = document.getElementById('general_notes')?.value || '';
      const unit = document.getElementById('general_unit')?.value || 'kg';

      if (!quantity || !cost) return toast('ç·æ¬å…¥é‡ã¨ç·å‡¦åˆ†æ–™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
      if (!facility) return toast('å‡¦åˆ†å ´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');

      await saveGeneralDisposalCost({
        yearMonth: state.selectedYearMonth,
        facility,
        quantity,
        unit,
        totalCost: cost,
        notes
      });
    }

    function updateListFilter(key, value) {
      state.listFilter[key] = value;
      render();
    }
    function clearListFilter() {
      state.listFilter = { q: '', facility: '', wasteType: '' };
      render();
      toast('çµã‚Šè¾¼ã¿ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'info');
    }

    // ========================================
    // ç²—åˆ©åˆ†æ
    // ========================================
    function renderAnalysis() {
      return `
        <div id="analysisTop" class="anchor"></div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
            <div>
              <h2>ğŸ“ˆ ç²—åˆ©ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‹é¡§å®¢ï¼‰</h2>
              <div class="subtitle">å¯¾è±¡å¹´æœˆï¼š<b>${escapeHtml(state.selectedYearMonth)}</b></div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn btn-secondary" type="button" onclick="goTo('dashboard','dashTop')">ğŸ  æˆ»ã‚‹</button>
              <button class="btn btn-primary" type="button" onclick="calculateProfit()">ğŸ”„ å†è¨ˆç®—</button>
            </div>
          </div>

          ${!state.profitAnalysis ? `
            <div class="panel" style="text-align:center;padding:40px;">
              <div style="font-size:56px;margin-bottom:14px;">ğŸ“Š</div>
              <div style="font-weight:900;margin-bottom:14px;font-size:16px;">ã¾ã ç²—åˆ©ãŒè¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
              <button class="btn btn-primary" type="button" onclick="calculateProfit()">âœ… ç²—åˆ©ã‚’è¨ˆç®—</button>
              <div class="hint" style="margin-top:14px;">
                â€» ä¸€èˆ¬ã¯ã‚«ãƒ†ã‚´ãƒªç²—åˆ©ï¼ç”£å»ƒ+å»ºå»ƒã¯ "å»ºç”£å»ƒ" ã¨ã—ã¦ã¾ã¨ã‚ã¦è¡¨ç¤ºã—ã¾ã™
              </div>
            </div>
          ` : renderAnalysisBody()}
        </div>
      `;
    }

    function renderAnalysisBody() {
      const { customerAnalysis, categorySummary } = state.profitAnalysis || {};
      const cs = categorySummary || {};

      // å»ºç”£å»ƒï¼ˆç”£å»ƒ + å»ºå»ƒï¼‰ã‚’åˆç®—
      const combined = {
        sales: (cs.industrial?.sales || 0) + (cs.construction?.sales || 0),
        cost:  (cs.industrial?.cost  || 0) + (cs.construction?.cost  || 0),
      };
      combined.profit = combined.sales - combined.cost;
      combined.profitRate = combined.sales > 0 ? (combined.profit / combined.sales) * 100 : 0;

      return `
        <h3 style="font-size:17px;font-weight:1000;margin:12px 0 14px;">ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆä¸€èˆ¬ï¼å»ºç”£å»ƒï¼‰</h3>
        <div class="grid grid-2">
          ${renderCategory('ğŸ—‘ï¸ ä¸€èˆ¬å»ƒæ£„ç‰©', cs.general || {sales:0,cost:0,profit:0,profitRate:0}, 'general')}
          ${renderCategory('ğŸ­ å»ºç”£å»ƒï¼ˆç”£å»ƒï¼‹å»ºå»ƒï¼‰', combined, 'combined')}
        </div>

        <h3 style="font-size:17px;font-weight:1000;margin:28px 0 14px;">ğŸ‘¥ é¡§å®¢åˆ¥ï¼ˆå»ºç”£å»ƒï¼‰</h3>
        ${(customerAnalysis || []).length === 0 ? `
          <div class="item" style="text-align:center;padding:24px;">
            <div class="muted">åˆ†æå¯¾è±¡ã®é¡§å®¢ãŒã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        ` : (customerAnalysis || []).map(c => renderProfitCard(c)).join('')}
      `;
    }

    function renderCategory(title, data, kind) {
      const isGeneral = kind === 'general';
      const generalCost = isGeneral ? state.disposalCosts.find(c => c.wasteType === 'ä¸€èˆ¬å»ƒæ£„ç‰©') : null;

      return `
        <div class="item">
          <div class="item-title">${escapeHtml(title)}</div>

          ${isGeneral && generalCost ? `
            <div class="item-sub" style="margin-top:6px;">
              å‡¦åˆ†å ´ï¼š${escapeHtml(generalCost.facility || '-')} ï¼
              æ¬å…¥é‡ï¼š${Number(generalCost.quantity||0).toLocaleString()} ${escapeHtml(generalCost.unit||'kg')}
            </div>
          ` : `
            <div class="item-sub" style="margin-top:6px;">
              â€» å®Ÿç¸¾è«‹æ±‚ä¸Šã¯åˆ†ã‹ã‚Œãªã„ãŸã‚ã€ç”£å»ƒï¼‹å»ºå»ƒã‚’çµ±åˆã—ã¦è¡¨ç¤º
            </div>
          `}

          <div class="item-grid" style="margin-top:14px;">
            <div>
              <div class="mini-label">å£²ä¸Š</div>
              <div class="mini-value">${formatCurrency(data.sales)}</div>
            </div>
            <div>
              <div class="mini-label">å‡¦åˆ†æ–™</div>
              <div class="mini-value">${formatCurrency(data.cost)}</div>
            </div>
            <div>
              <div class="mini-label">ç²—åˆ© / ç²—åˆ©ç‡</div>
              <div class="mini-value" style="color:${(data.profit||0)<0?'#dc2626':'#059669'}">
                ${formatCurrency(data.profit)}ï¼ˆ${formatPercent(data.profitRate)}ï¼‰
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderProfitCard(customer) {
      return `
        <div class="profit-card ${escapeHtml(customer.profitWarningLevel)}">
          <div class="profit-head">
            <div class="item-title">${escapeHtml(customer.customerName || '-')}</div>
            <div class="profit-rate ${escapeHtml(customer.profitWarningLevel)}">
              ${formatPercent(customer.totalProfitRate)}
            </div>
          </div>

          <div class="item-grid">
            <div>
              <div class="mini-label">å£²ä¸Š</div>
              <div class="mini-value">${formatCurrency(customer.totalSales)}</div>
            </div>
            <div>
              <div class="mini-label">å‡¦åˆ†æ–™</div>
              <div class="mini-value">${formatCurrency(customer.totalCost)}</div>
            </div>
            <div>
              <div class="mini-label">ç²—åˆ©</div>
              <div class="mini-value" style="color:${(customer.totalProfit||0)<0?'#dc2626':'#059669'}">
                ${formatCurrency(customer.totalProfit)}
              </div>
            </div>
          </div>

          ${customer.profitWarningLevel === 'danger' ? `
            <div class="warn">
              âš ï¸ å£²ä¸Šã‚ˆã‚Šå‡¦åˆ†æ–™ãŒé«˜ãã€èµ¤å­—å–å¼•ã¨ãªã£ã¦ã„ã¾ã™ã€‚<br/>
              ä¾¡æ ¼æ”¹å®šãƒ»å›åãƒ«ãƒ¼ãƒˆãƒ»é‹è³ƒãƒ»å‡¦åˆ†å˜ä¾¡ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
            </div>
          ` : ``}
        </div>
      `;
    }
  </script>
</body>
</html>
